name: chatclub

volumes:
  postgres_data:
  go_build_cache:   # dev の go build キャッシュ
  go_mod_cache:     # dev の go mod キャッシュ

networks:
  chatclub_network:
    driver: bridge

services:
  postgres:
    image: postgres:16
    container_name: chatclub_postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      TZ: ${POSTGRES_TZ:-UTC}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - chatclub_network

  # 本番（Dockerfile のステージ: prod）
  app:
    profiles: ["prod"]
    build:
      context: .
      target: prod
    container_name: chatclub_backend
    depends_on:
      - postgres
    environment:
      DISCORD_TOKEN: ${DISCORD_TOKEN}
      DISCORD_APP_ID: ${DISCORD_APP_ID}
      DISCORD_GUILD_IDS: ${DISCORD_GUILD_IDS}
      DISCORD_REGISTER_COMMANDS: ${DISCORD_REGISTER_COMMANDS:-false}
      DB_HOST: ${DB_HOST:-postgres}
      DB_PORT: ${DB_PORT:-5432}
      DB_USER: ${POSTGRES_USER}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_NAME: ${POSTGRES_DB}
      PORT: ${APP_PORT:-8080}
      CAPCOM_EMAIL: ${CAPCOM_EMAIL}
      CAPCOM_PASSWORD: ${CAPCOM_PASSWORD}
      BUCKLER_COOKIE_ENC_KEY: ${BUCKLER_COOKIE_ENC_KEY}
      BUCKLER_LANG: ${BUCKLER_LANG:-ja-jp}
      BUCKLER_BASE_URL: ${BUCKLER_BASE_URL:-https://www.streetfighter.com/6/buckler}
      BUCKLER_CLIENT_ID: ${BUCKLER_CLIENT_ID}
      BUCKLER_REDIRECT_URI: ${BUCKLER_REDIRECT_URI:-https://www.streetfighter.com/6/buckler/auth/login}
      BUCKLER_SCOPE: ${BUCKLER_SCOPE:-openid}
      BUCKLER_AUDIENCE: ${BUCKLER_AUDIENCE:-urn:rebe:capcom:apis}
      BUCKLER_RESPONSE_TYPE: ${BUCKLER_RESPONSE_TYPE:-code}
      BUCKLER_DEBUG: ${BUCKLER_DEBUG:-0}
      SF6_POLL_INTERVAL: ${SF6_POLL_INTERVAL:-4h}
      SF6_POLL_MAX_PAGES: ${SF6_POLL_MAX_PAGES:-10}
      SF6_POLL_ACCOUNT_DELAY_MAX: ${SF6_POLL_ACCOUNT_DELAY_MAX:-3s}
      SF6_FETCH_ALLOWED_USER_IDS: ${SF6_FETCH_ALLOWED_USER_IDS:-}
    ports:
      - "${APP_PORT:-8080}:8080"
    networks: [chatclub_network]
    restart: unless-stopped

  # 開発（Dockerfile のステージ: dev）
  app-dev:
    profiles: ["dev"]
    build:
      context: .
      target: dev
    container_name: chatclub_dev_backend
    depends_on:
      - postgres
    environment:
      DISCORD_TOKEN: ${DISCORD_TOKEN}
      DISCORD_APP_ID: ${DISCORD_APP_ID}
      DISCORD_GUILD_IDS: ${DISCORD_GUILD_IDS}
      DISCORD_REGISTER_COMMANDS: ${DISCORD_REGISTER_COMMANDS:-false}
      DB_HOST: ${DB_HOST:-postgres}
      DB_PORT: ${DB_PORT:-5432}
      DB_USER: ${POSTGRES_USER}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_NAME: ${POSTGRES_DB}
      PORT: ${APP_PORT:-8080}
      CAPCOM_EMAIL: ${CAPCOM_EMAIL}
      CAPCOM_PASSWORD: ${CAPCOM_PASSWORD}
      BUCKLER_COOKIE_ENC_KEY: ${BUCKLER_COOKIE_ENC_KEY}
      BUCKLER_LANG: ${BUCKLER_LANG:-ja-jp}
      BUCKLER_BASE_URL: ${BUCKLER_BASE_URL:-https://www.streetfighter.com/6/buckler}
      BUCKLER_CLIENT_ID: ${BUCKLER_CLIENT_ID}
      BUCKLER_REDIRECT_URI: ${BUCKLER_REDIRECT_URI:-https://www.streetfighter.com/6/buckler/auth/login}
      BUCKLER_SCOPE: ${BUCKLER_SCOPE:-openid}
      BUCKLER_AUDIENCE: ${BUCKLER_AUDIENCE:-urn:rebe:capcom:apis}
      BUCKLER_RESPONSE_TYPE: ${BUCKLER_RESPONSE_TYPE:-code}
      BUCKLER_DEBUG: ${BUCKLER_DEBUG:-0}
      SF6_POLL_INTERVAL: ${SF6_POLL_INTERVAL:-4h}
      SF6_POLL_MAX_PAGES: ${SF6_POLL_MAX_PAGES:-10}
      SF6_POLL_ACCOUNT_DELAY_MAX: ${SF6_POLL_ACCOUNT_DELAY_MAX:-3s}
      SF6_FETCH_ALLOWED_USER_IDS: ${SF6_FETCH_ALLOWED_USER_IDS:-}
    ports:
      - "${APP_PORT:-8080}:8080"
    # airに必要 ボリュームをマウント
    volumes:
      - .:/app
      - go_build_cache:/root/.cache/go-build
      - go_mod_cache:/go/pkg/mod
    networks: [chatclub_network]
    restart: unless-stopped
