# 匿名チャット機能 フロー

本機能には「専用チャンネル方式」と「/anon コマンド方式」の2系統がある。

---

## 1. 専用チャンネル方式（Message Create）

1. Bot がメッセージ作成イベントを受け取る
2. 対象チャンネルが匿名チャンネルかを判定
3. Bot/Webhook の投稿なら無視
4. **元メッセージを先に削除**
5. Webhook を取得（なければ作成して保存）
6. Webhook で匿名投稿を送信
   - 本文 + 添付を転送

### 1.1 失敗時の扱い

- Webhook 送信に失敗した場合、元メッセージは復元できない
- 失敗内容はログに記録する（ユーザIDや内容は残さない）

---

## 2. `/anon` コマンド方式

1. ユーザが `/anon` を実行
2. 入力内容・添付を検証
3. Webhook を取得（なければ作成して保存）
4. Webhook で匿名投稿
5. 実行者にエフェメラル応答

### 2.1 失敗時の扱い

- Webhook が使えない場合はエフェメラルで失敗通知
- 投稿は行わない

---

## 3. 添付ファイルの扱い

- 添付は **再送信**で対応する
- サイズ超過や取得失敗時は該当添付のみ省略する
- 省略時は本文に警告文を付与する（例: "一部の添付は省略された")
